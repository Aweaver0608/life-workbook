<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>12-Week Interactive Workbook: Design, Surrender, Dare</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Warm Neutrals (bg-slate-50) with accents of Blue (DYL), Terracotta (STL), and Teal (DG) -->
    <!-- Application Structure Plan: A single-page application using a vertical accordion structure for the 12 weeks. This version has been restructured to provide a clear, day-by-day schedule (Mon-Fri) within each week, tailored to a 30-min/day schedule with a longer 1-2 hour Friday "Deep Dive". This makes the plan more actionable and easier to follow. Interactive components for DYL exercises are now embedded within the specific day's task list. -->
    <!-- Visualization & Content Choices: The primary visualization remains the top progress bar. The key change is the restructuring of the weekly content into a daily schedule. Interactive HTML/CSS/JS components for specific workbook exercises (Dashboard, Odyssey Plan, etc.) are now presented within the context of a specific day's task, primarily on Fridays. The Mind Mapping component is now dynamic, pulling data from the Good Time Journal entries and sorting them by relevance (engagement, energy, flow). Gemini API features are retained and enhanced with contextual memory from previous weeks' inputs. A floating action button and modal have been added for Good Time Journal entries to improve usability, now including edit functionality. The Weekly Integration Notes are now dynamically generated by the Gemini API based on the user's inputs for that week. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .accordion-header.active + .accordion-content {
            max-height: 10000px; /* Increased max-height for larger components */
        }
        .progress-bar-item {
            transition: all 0.5s ease-in-out;
        }
        .progress-bar-item.completed {
            background-color: #4ade80; /* green-400 */
            color: white;
        }
        textarea {
            resize: vertical;
        }
        .gemini-button {
            background-color: #f0f9ff;
            color: #0284c7;
            border: 1px solid #bae6fd;
        }
        .gemini-button:hover {
            background-color: #e0f2fe;
        }
        .gemini-button:disabled {
            background-color: #e2e8f0;
            color: #94a3b8;
            cursor: not-allowed;
            border-color: #cbd5e1;
        }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Custom styles for sliders */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]:focus {
            outline: none;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #d1d5db; /* gray-300 */
            border-radius: 5px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            border: 2px solid #fff;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6; /* blue-500 */
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 2px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">12-Week Interactive Workbook</h1>
            <p class="text-lg text-slate-600 mt-2">Design, Surrender, Dare</p>
        </header>

        <section id="getting-started" class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h2 class="text-2xl font-bold mb-4 text-slate-900">Getting Started</h2>
            <p class="text-slate-600 mb-6">This is your anchor. When the process feels challenging, return to this statement to remember your motivation. This is for you, from you.</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-slate-700 mb-1">Start Date</label>
                    <input type="date" id="start-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-slate-700 mb-1">Target Completion Date</label>
                    <input type="date" id="end-date" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
            <div>
                <label for="why" class="block text-sm font-medium text-slate-700 mb-1">Why I'm Doing This</label>
                <textarea id="why" rows="3" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder='"I am undertaking this journey to..."'></textarea>
            </div>
        </section>

        <section id="resource-library" class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h2 class="text-2xl font-bold mb-4 text-slate-900">Resource Library</h2>
             <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 rounded-r-lg flex items-center justify-between" role="alert">
                <div>
                    <p class="font-bold">Access Your PDFs in Google Drive</p>
                    <p class="text-sm">Click the button to open Google Drive in a new tab and navigate to your "Life Planner" folder.</p>
                </div>
                <a href="https://drive.google.com" target="_blank" class="ml-4 flex-shrink-0 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    Open Google Drive
                </a>
            </div>
        </section>

        <section id="main-progress-tracker" class="bg-white p-6 rounded-xl shadow-sm mb-8">
            <h2 class="text-2xl font-bold mb-4 text-slate-900">Main Progress Tracker</h2>
            <div id="progress-bar-container" class="grid grid-cols-6 md:grid-cols-12 gap-2 text-center">
            </div>
        </section>

        <main id="workbook-weeks">
        </main>

        <footer class="text-center mt-12 text-slate-500">
            <p>Your journey is your own. Embrace the process.</p>
        </footer>

    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-8 right-8 space-y-3">
        <button id="fab-view-journal" class="bg-white hover:bg-slate-100 text-slate-700 rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
        </button>
        <button id="fab-add-journal" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg transition-transform transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
        </button>
    </div>

    <!-- Journal Entry Modal -->
    <div id="journal-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 id="journal-modal-title" class="text-xl font-bold text-slate-900 mb-4">Add Good Time Journal Entry</h3>
            <div class="space-y-4">
                <div>
                    <label for="journal-activity-input" class="block text-sm font-medium text-slate-700">Activity</label>
                    <input type="text" id="journal-activity-input" class="mt-1 w-full p-2 border border-slate-300 rounded-lg" placeholder="e.g., Team Meeting">
                </div>
                <div>
                    <label for="journal-engagement-input" class="block text-sm font-medium text-slate-700">Engagement (1-10)</label>
                    <input type="number" id="journal-engagement-input" min="1" max="10" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
                </div>
                <div>
                    <label for="journal-energy-input" class="block text-sm font-medium text-slate-700">Energy (1-10)</label>
                    <input type="number" id="journal-energy-input" min="1" max="10" class="mt-1 w-full p-2 border border-slate-300 rounded-lg">
                </div>
            </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="cancel-journal-entry" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg">Cancel</button>
                <button id="save-journal-entry" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Save Entry</button>
            </div>
        </div>
    </div>

    <!-- Journal View Modal -->
    <div id="journal-view-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-slate-900">Good Time Journal Entries</h3>
                <button id="close-journal-view" class="text-slate-500 hover:text-slate-800 text-2xl font-bold">&times;</button>
            </div>
            <div id="journal-view-content" class="max-h-[60vh] overflow-y-auto space-y-3 pr-2">
                <p class="text-slate-500">No entries yet. Use the '+' button to add your first one!</p>
            </div>
        </div>
    </div>


    <script>
        const workbookData = [
            {
                week: 1,
                title: "Building Your Compass",
                quote: "The first step in solving any problem is to name it and own it.",
                color: "blue",
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Introduction & Chapter 1, 'Start Where You Are.'", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'STL', type: 'Listen', content: "Chapters 1-6 (Intro & 'It All Begins with Love').", notes: true, placeholder: "Notes on today's listening..." }],
                    wednesday: [{ book: 'DG', type: 'Listen', content: "Introduction & Chapter 1, 'Scarcity'.", notes: true, placeholder: "Notes on today's listening..." }],
                    thursday: [{ book: 'All', type: 'Reflection', content: "Reflect on the week's key ideas.", question: { prompt: "DG Prompt", text: "Brené Brown defines vulnerability as 'uncertainty, risk, and emotional exposure.' Where in your life do you feel the most emotional exposure right now?"} }],
                    friday: [
                        { book: 'DYL', type: 'Deep Dive Activity', content: "Complete the **Health/Work/Play/Love Dashboard**.", component: "dashboard" },
                        { book: 'DYL', type: 'Deep Dive Activity', content: "Write your **Workview** and **Lifeview** reflections.", component: "workviewLifeview" }
                    ]
                },
                saturdayPrototype: { content: "This week is about assessment. A prototype can be a conversation. Who could you talk to for 15 minutes to get an outside perspective on one area of your Dashboard?", aiPrototype: true },
                integration: "Look at your Workview and Lifeview. Where do the concepts of surrendering control (STL) and embracing vulnerability (DG) fit in? Where do they clash with your current views?"
            },
            {
                week: 2,
                title: "Love, Fear & Journaling",
                quote: "Perfect love drives out fear. (1 John 4:18)",
                color: "red",
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 2, 'Building a Compass' & Chapter 3, 'Wayfinding'.", notes: true, placeholder: "Notes on today's listening...", reminder: "Log a Good Time Journal entry today." }],
                    tuesday: [{ book: 'STL', type: 'Listen', content: "Chapter 7, 'Love and Fear.'", question: { prompt: "STL Question", text: "What makes it hard for you to believe that God does not want your fear, only your friendship? How do fears block your response to God's love?" }, reminder: "Log a Good Time Journal entry today." }],
                    wednesday: [{ book: 'DG', type: 'Listen', content: "Chapter 2, 'Debunking the Vulnerability Myths.'", question: { prompt: "DG Prompt", text: "The opposite of scarcity isn't abundance; it's 'enough.' Write down three things you have or are that are 'enough' for today, especially in your role as a father and husband." }, reminder: "Log a Good Time Journal entry today." }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Review your **Good Time Journal** entries so far. What patterns are emerging?", component: "goodTimeJournalContinue", reminder: "Log a Good Time Journal entry today." }],
                    friday: [{ book: 'All', type: 'Deep Dive Reflection', content: "Reflect on the week's themes of love, fear, and scarcity.", notes: true, placeholder: "How do these themes connect for you?", reminder: "Log a Good Time Journal entry today." }]
                },
                saturdayPrototype: { content: "Based on your journal, what is one low-energy/low-engagement activity you could 'prototype' doing differently?", aiPrototype: true },
                integration: "How does the fear of 'not being enough' (DG's scarcity) show up in your relationship with God (STL's love vs. fear)? How does it affect what you log in your Good Time Journal?"
            },
            {
                week: 3,
                title: "Surrender, Obedience & Shame",
                quote: "Many frustrations are the result of unspoken expectations.",
                color: "green",
                 schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 4, 'Getting Unstuck.'", notes: true, placeholder: "Notes on today's listening...", reminder: "Log a Good Time Journal entry today." }],
                    tuesday: [{ book: 'STL', type: 'Listen', content: "Chapter 8, 'Surrender and Obedience.'", question: { prompt: "STL Question", text: "What, if any, difference do you think exists between obedience as an act of the will and surrender as a choice of the heart? Which is harder, and why?" }, reminder: "Log a Good Time Journal entry today." }],
                    wednesday: [{ book: 'DG', type: 'Listen', content: "Chapter 3, 'Understanding and Combating Shame' (Part 1).", notes: true, placeholder: "Notes on today's listening...", reminder: "Log a Good Time Journal entry today." }],
                    thursday: [{ book: 'DG', type: 'Listen', content: "Chapter 3, 'Understanding and Combating Shame' (Part 2).", question: { prompt: "DG Prompt", text: "Perfectionism is a 20-ton shield. What are you trying to protect yourself from by trying to be perfect (e.g., at work, as a husband/father)? What mistake are you terrified of making?" }, reminder: "Log a Good Time Journal entry today." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Continue your Good Time Journal and review the week's entries.", component: "goodTimeJournalContinue", reminder: "Log a Good Time Journal entry today." }]
                },
                saturdayPrototype: { content: "Prototype 'willingness over willfulness' (STL). Choose one small, frustrating thing you'd normally try to force or control and instead, practice releasing the outcome.", aiPrototype: true },
                integration: "Is your drive for 'obedience' (in your faith, work, etc.) sometimes a form of perfectionism (DG)? How does the idea of 'surrender' offer a different path?"
            },
            { 
                week: 4, 
                title: "Transformation & Vulnerability", 
                quote: "If you want to achieve more, there is some relationship that can unlock better results.", 
                color: "blue", 
                schedule: {
                    monday: [{ book: 'STL', type: 'Listen', content: "Chapter 9, 'Transformed by Love.'", question: { prompt: "STL Question", text: "It is not the fact of being loved that is life changing but the experience of allowing our selves to be loved in vulnerability. At what point do you turn back from the invitations of love?" }, reminder: "Log a Good Time Journal entry today." }],
                    tuesday: [{ book: 'DG', type: 'Listen', content: "Chapter 4, 'The Vulnerability Armory' (Part 1).", notes: true, placeholder: "Notes on today's listening...", reminder: "Log a Good Time Journal entry today." }],
                     wednesday: [{ book: 'DG', type: 'Listen', content: "Chapter 4, 'The Vulnerability Armory' (Part 2).", question: { prompt: "DG Prompt", text: "'Minding the gap' means practicing gratitude for what we have while reaching for what we want. What's one thing you're grateful for in your career right now, and what's one thing you're striving for?" }, reminder: "Log a Good Time Journal entry today." }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Finalize your **Good Time Journal** entries for the past 3 weeks.", reminder: "Log a Good Time Journal entry today." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Review your completed Good Time Journal. What are the key patterns of engagement and energy?", component: "goodTimeJournalContinue", reminder: "Log a Good Time Journal entry today." }]
                },
                saturdayPrototype: { content: "Look at a high-energy activity from your journal. What's one way you could bring a small piece of that into a low-energy part of your week?", aiPrototype: true },
                integration: "True transformation (STL) requires vulnerability (DG). How can the insights from your Good Time Journal (DYL) point toward a life that feels more authentic and less like a performance?" 
            },
            { 
                week: 5, 
                title: "Mind Mapping & Designing Lives", 
                quote: "Chase your desired lifestyle, not your desired title.", 
                color: "red", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 5, 'Design Your Lives.'", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'STL', type: 'Listen', content: "Chapter 10, 'Becoming Love.'", notes: true, placeholder: "Notes on today's listening..." }],
                    wednesday: [{ book: 'DG', type: 'Listen', content: "Chapter 5, 'Mind the Gap.'", notes: true, placeholder: "Notes on today's listening..." }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Brainstorm ideas for your 3 Odyssey Plans." , notes: true, placeholder: "Initial ideas for Life 1, 2, and 3..."}],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Based on your journal, create **three Mind Maps**.", component: "mindMapping" }]
                },
                saturdayPrototype: { content: "Take one of the 'job descriptions' you created from your Mind Maps. What is one tiny, 1-hour version of that you could do?", aiPrototype: true },
                integration: "This week is about creative work. Use the insights from your Mind Maps to fuel your Odyssey Plans next week." 
            },
            { 
                week: 6, 
                title: "Odyssey Plans & Engagement", 
                quote: "Mental toughness is not skipping the days that are easy to skip.", 
                color: "green", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 6, 'Prototyping.'", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'STL', type: 'Listen', content: "Chapters 11-12, Epilogue." , question: { prompt: "STL Question", text: "If we are not in the process of becoming more loving, something is seriously wrong with our spirituality. How are you doing in the School of Love that is the essence of Christian spirituality?" } }],
                    wednesday: [{ book: 'DG', type: 'Listen', content: "Chapter 6, 'Disruptive Engagement.'", notes: true, placeholder: "Notes on today's listening..." }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Draft your 3 Odyssey Plans.", notes: true, placeholder: "Drafts of your plans..." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Finalize your three **Odyssey Plans**.", component: "odysseyPlan" }]
                },
                saturdayPrototype: { content: "Pick ONE question from ONE of your Odyssey Plans. What is the fastest, cheapest way to get a tiny bit of data on it?", aiPrototype: true },
                integration: "How does the goal of 'becoming love' (STL) change the way you think about your career paths in the Odyssey Plans? Does one path feel more aligned with that goal?" 
            },
            { 
                week: 7, 
                title: "Wholehearted Parenting & Failure", 
                quote: "Start with the best opportunity available to you.", 
                color: "blue", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 7, 'How Not to Get a Job' (aka Failure Immunity).", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'DG', type: 'Listen', content: "Chapter 7, 'Wholehearted Parenting' (Part 1).", notes: true, placeholder: "Notes on today's listening..." }],
                    wednesday: [{ book: 'DG', type: 'Listen', content: "Chapter 7, 'Wholehearted Parenting' (Part 2).", question: { prompt: "DG Prompt", text: "What is one thing you can do this week to model 'wholeheartedness' for your children, showing them it's okay to be imperfect and vulnerable?" } }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Brainstorm a 'prototype experience' (e.g., volunteer for an hour, take a short online tutorial).", notes: true, placeholder: "Prototype ideas..." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Brainstorm a list of people for a 'Life Design Interview' and reach out to ONE person.", notes: true, placeholder: "Draft your email/message here..." }]
                },
                saturdayPrototype: { content: "Have the Life Design Interview you scheduled. Your only goal is to listen to their story.", notes: true, placeholder: "Notes from your conversation..." },
                integration: "Prototyping (DYL) is an act of vulnerability (DG). It's admitting you don't have the answers and need to explore. How does seeing it this way change the experience for you?" 
            },
            { 
                week: 8, 
                title: "Dream Jobs & Sharing Plans", 
                quote: "Relationships are usually the most important thing.", 
                color: "red", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 8, 'Designing Your Dream Job.'", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'DYL', type: 'Activity', content: "Identify your Life Design Team.", component: "teamBuilding" }],
                    wednesday: [{ book: 'DYL', type: 'Activity', content: "Schedule a feedback session with your team.", notes: true, placeholder: "Plan for the meeting..." }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Prepare to share your three Odyssey Plans.", notes: true, placeholder: "Key points to share..." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Have your feedback session with your team. Your goal is to listen and see what energizes you as you share.", notes: true, placeholder: "Notes from the meeting..." }]
                },
                saturdayPrototype: { content: "After your feedback session, what is one small adjustment you want to make to one of your plans?", notes: true },
                integration: "Sharing your Odyssey Plans is a huge act of daring greatly. Notice what feelings come up before, during, and after you share. This is the heart of the work." 
            },
            { 
                week: 9, 
                title: "Choosing Happiness & Resilience", 
                quote: "If you make a mistake that is hard to reverse... you must always make the most of the situation you are in.", 
                color: "green", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 9, 'Choosing Happiness.'", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'STL', type: 'Reflection', content: "Reflect on grace.", question: { prompt: "STL Question", text: "How does the concept of God's unconditional love and grace help you reframe your 'failures' not as indictments of your worth, but as part of the human experience?" } }],
                    wednesday: [{ book: 'DG', type: 'Reflection', content: "Reflect on shame vs. guilt.", question: { prompt: "DG Prompt", text: "Shame says 'I am bad.' Guilt says 'I did something bad.' Look at your failure log. Can you re-categorize any 'I am bad' moments into 'I did something bad' moments?" } }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Log your failures for the Failure Reframe Exercise." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Complete the **Failure Reframe Exercise**.", component: "failureReframe" }]
                },
                saturdayPrototype: { content: "Choose one of your 'growth opportunity' failures. Prototype the 'critical success factor' you identified.", aiPrototype: true },
                integration: "This week is the ultimate integration. Use the grace from STL and the resilience from DG to power your failure reframe from DYL. Failure is just data." 
            },
            { 
                week: 10, 
                title: "Failure Immunity & Building Your Team", 
                quote: "Committing to the process and the people who support it.", 
                color: "blue", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 10, 'Failure Immunity.'", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'STL', type: 'Reflection', content: "Reflect on trust and happiness.", question: { prompt: "STL Question", text: "St. Ignatius says sin is the 'unwillingness to trust that what God wants is our deepest happiness.' How does this idea connect to the DYL concept of 'choosing happiness'?" } }],
                    wednesday: [{ book: 'DG', type: 'Reflection', content: "Reflect on your support system.", question: { prompt: "DG Prompt", text: "A support team is a key part of building shame resilience. How does having a Life Design Team feel like a practical way to ensure you don't have to 'go it alone'?" } }],
                    thursday: [{ book: 'DYL', type: 'Activity', content: "Review all your work so far: Dashboard, Journal, Mind Maps, Odyssey Plans.", notes: true, placeholder: "Key takeaways from your review..." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Decide which path, or combination of paths, holds the most energy for you *right now*.", notes: true, placeholder: "My chosen direction for now is..." }]
                },
                saturdayPrototype: { content: "Have the first official meeting with your Life Design Team. Topic: 'What's my next small prototype to move forward on the path I'm choosing?'", aiPrototype: true },
                integration: "You're not choosing a final path. You're choosing the next experiment. How does that distinction lower the pressure?" 
            },
            { 
                week: 11, 
                title: "Building a Team & Final Thoughts", 
                quote: "Synthesizing your learning and planning your next move.", 
                color: "red", 
                schedule: {
                    monday: [{ book: 'DYL', type: 'Listen', content: "Chapter 11, 'Building a Team' & Conclusion.", notes: true, placeholder: "Notes on today's listening..." }],
                    tuesday: [{ book: 'DG', type: 'Listen', content: "Final Thoughts.", notes: true, placeholder: "Notes on today's listening..." }],
                    wednesday: [{ book: 'DYL', type: 'Review', content: "Review your favorite **Odyssey Plan**. What's the first step?", notes: true, placeholder: "First step is..." }],
                    thursday: [{ book: 'DYL', type: 'Review', content: "Review your **Failure Reframe log**. What have you learned?", notes: true, placeholder: "Key learnings..." }],
                    friday: [{ book: 'DYL', type: 'Deep Dive Activity', content: "Create a **Next 90 Days Plan**.", component: "reviewAndPlan" }]
                },
                saturdayPrototype: { content: "Take the absolute smallest first step on your 90-day plan.", aiPrototype: true },
                integration: "A well-designed life is not a destination; it's a process of continuous prototyping and surrendering the outcome. It's about daring to show up and try." 
            },
            { 
                week: 12, 
                title: "Conclusion & Commencement", 
                quote: "Celebrating your progress and committing to the journey ahead.", 
                color: "green", 
                schedule: {
                    monday: [{ book: 'STL', type: 'Final Reflection', content: "What does it mean to you now to live a life of surrender to love?", notes: true, placeholder: "Reflection..." }],
                    tuesday: [{ book: 'DG', type: 'Final Reflection', content: "What does it mean to you now to dare greatly?", notes: true, placeholder: "Reflection..." }],
                    wednesday: [{ book: 'DYL', type: 'Final Reflection', content: "What does it mean to you now to live a well-designed life?", notes: true, placeholder: "Reflection..." }],
                    thursday: [{ book: 'All', type: 'Final Reflection', content: "Write a letter to your future self about what you've learned and what you hope to remember.", component: "finalReflection" }],
                    friday: [{ book: 'All', type: 'Deep Dive Activity', content: "Celebrate your journey!", component: "celebration" }]
                },
                saturdayPrototype: { content: "This isn't a prototype, it's a celebration! What will you do to mark this milestone?", notes: true },
                integration: "You've done the work. The goal was never to find a perfect, final answer. The goal was to build a set of tools and a mindset to navigate life with more intention, courage, and grace. Well done." 
            }
        ];

        const progressBarContainer = document.getElementById('progress-bar-container');
        const workbookWeeksContainer = document.getElementById('workbook-weeks');
        let progressState = {};
        let goodTimeJournal = [];
        let editingJournalIndex = null;

        const colorMap = {
            blue: { bg: 'bg-blue-600', text: 'text-blue-600', border: 'border-blue-500' },
            red: { bg: 'bg-rose-600', text: 'text-rose-600', border: 'border-rose-500' },
            green: { bg: 'bg-emerald-600', text: 'text-emerald-600', border: 'border-emerald-500' }
        };

        function getHistoricalContext(currentWeek) {
            let context = "";
            const whyText = document.getElementById('why').value;
            if (whyText) {
                context += `The user's core motivation for this journey is: "${whyText}".\n\n`;
            }

            for (let i = 1; i < currentWeek; i++) {
                const weekContainer = document.querySelector(`.week-container[data-week-id="${i}"]`);
                if (weekContainer) {
                    let weekContext = "";
                    const textareas = weekContainer.querySelectorAll('textarea');
                    textareas.forEach(area => {
                        if (area.value) {
                            weekContext += `- ${area.value}\n`;
                        }
                    });
                    if (weekContext) {
                        context += `--- WEEK ${i} REFLECTIONS ---\n${weekContext}\n`;
                    }
                }
            }
            return context;
        }

        async function callGemini(prompt, button) {
            const originalButtonContent = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<div class="loader mx-auto"></div>';
            
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API request failed with status ${response.status}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return "Sorry, I couldn't generate a response. Please try again.";
                }
            } catch (error) {
                console.error("Gemini API call failed:", error);
                return "An error occurred. Please check the console for details.";
            } finally {
                button.disabled = false;
                button.innerHTML = originalButtonContent;
            }
        }

        function initializeApp() {
            workbookData.forEach(weekData => {
                progressState[`week${weekData.week}`] = false;
                progressBarContainer.innerHTML += `
                    <div id="progress-item-${weekData.week}" class="progress-bar-item bg-slate-200 rounded-lg p-2 font-bold text-slate-600">
                        ${weekData.week}
                    </div>
                `;
                workbookWeeksContainer.innerHTML += createWeekAccordion(weekData);
            });

            addEventListeners();
        }

        function renderComponent(task) {
            switch(task.component) {
                case 'dashboard':
                    return `
                        <div class="space-y-4 p-4 bg-slate-100 rounded-lg">
                            ${['Health', 'Work', 'Play', 'Love'].map(item => `
                                <div>
                                    <div class="flex justify-between items-center mb-1">
                                        <label class="font-medium text-slate-700">${item}</label>
                                        <span id="dashboard-value-${item.toLowerCase()}" class="text-sm font-bold text-blue-600">50%</span>
                                    </div>
                                    <input type="range" min="0" max="100" value="50" class="w-full" data-label-id="dashboard-value-${item.toLowerCase()}">
                                    <textarea rows="2" class="mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="How is it going in the area of ${item}?"></textarea>
                                </div>
                            `).join('')}
                        </div>
                    `;
                case 'workviewLifeview':
                    return `
                        <div class="space-y-6 p-4 bg-slate-100 rounded-lg">
                            <div>
                                <h4 class="font-semibold text-slate-800">Workview Reflection</h4>
                                <p class="text-xs text-slate-500 mt-1">What is work for? What does it mean? What defines good work?</p>
                                <textarea rows="5" class="mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="Write about 250 words..."></textarea>
                            </div>
                            <div>
                                <h4 class="font-semibold text-slate-800">Lifeview Reflection</h4>
                                <p class="text-xs text-slate-500 mt-1">Why are we here? What is the meaning/purpose of life? What matters most?</p>
                                <textarea rows="5" class="mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="Write about 250 words..."></textarea>
                            </div>
                        </div>
                    `;
                case 'goodTimeJournal':
                case 'goodTimeJournalContinue':
                    return `
                        <div class="p-4 bg-slate-100 rounded-lg">
                            <div class="journal-entries-container space-y-3">
                                <p class="text-xs text-slate-500">Your journal entries will appear here. Use the floating '+' button to add new entries daily.</p>
                            </div>
                        </div>
                    `;
                case 'mindMapping':
                    return `
                        <div class="space-y-4 p-4 bg-slate-100 rounded-lg">
                            <button class="populate-mind-map-btn text-sm font-semibold py-2 px-4 rounded-lg w-full gemini-button">Load Topics from Journal</button>
                            <p class="text-xs text-slate-500 text-center mt-1">Click above to populate dropdowns from your Good Time Journal entries.</p>
                            ${['Engagement', 'Energy', 'Flow'].map(mapType => `
                                <div class="p-3 bg-white rounded-lg border">
                                    <h5 class="font-semibold text-slate-800">Mind Map: ${mapType}</h5>
                                    <p class="text-xs text-slate-500 mt-1">Sorted by highest ${mapType}.</p>
                                    <select class="mind-map-select mt-2 w-full p-2 border text-sm rounded-md" data-sort-key="${mapType.toLowerCase()}">
                                        <option>Select a Central Topic</option>
                                    </select>
                                    <textarea rows="3" class="mt-2 w-full p-2 border text-sm rounded-md" placeholder="Primary and secondary associations..."></textarea>
                                    <input type="text" class="mt-2 w-full p-2 border text-sm rounded-md" placeholder="Combine 3 items into a fun job description...">
                                </div>
                            `).join('')}
                        </div>
                    `;
                case 'odysseyPlan':
                    return `
                        <div class="space-y-8 p-4 bg-slate-100 rounded-lg">
                            ${[1, 2, 3].map(i => `
                                <div class="p-4 border border-slate-200 rounded-xl bg-white">
                                    <h5 class="text-lg font-bold text-slate-800">Odyssey Plan #${i}</h5>
                                    <div class="mt-4 space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700">Six-Word Title</label>
                                            <input type="text" class="mt-1 w-full p-2 border text-sm rounded-md" placeholder="e.g., 'All In - The Silicon Valley Story'">
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                            ${['Resources', 'Likability', 'Confidence', 'Coherence'].map(gauge => `
                                                <div>
                                                    <div class="flex justify-between items-center mb-1">
                                                        <label class="font-medium text-slate-700 text-sm">${gauge}</label>
                                                        <span id="odyssey-value-${i}-${gauge.toLowerCase()}" class="text-xs font-bold text-blue-600">50%</span>
                                                    </div>
                                                    <input type="range" min="0" max="100" value="50" class="w-full" data-label-id="odyssey-value-${i}-${gauge.toLowerCase()}">
                                                </div>
                                            `).join('')}
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700">Questions this plan addresses</label>
                                            <textarea rows="2" class="mt-1 w-full p-2 border text-sm rounded-md" placeholder="e.g., 'Do I have what it takes?'"></textarea>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-slate-700">5-Year Timeline</label>
                                            <div class="mt-1 grid grid-cols-1 md:grid-cols-5 gap-2">
                                                ${[1,2,3,4,5].map(y => `<textarea rows="3" class="w-full p-2 border text-xs rounded-md" placeholder="Year ${y}"></textarea>`).join('')}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                case 'teamBuilding':
                    return `<textarea rows="4" class="w-full p-2 border text-sm rounded-md" placeholder="List 3-5 people for your Life Design Team..."></textarea>`;
                case 'failureReframe':
                    return `
                        <div class="p-4 bg-slate-100 rounded-lg">
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm bg-white">
                                    <thead class="bg-slate-200">
                                        <tr>
                                            <th class="p-2 text-left font-semibold text-slate-600">Failure</th>
                                            <th class="p-2 text-left font-semibold text-slate-600">Category</th>
                                            <th class="p-2 text-left font-semibold text-slate-600">Growth Insight</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="failure-table-body">
                                    </tbody>
                                </table>
                            </div>
                            <button id="add-failure-btn" class="mt-4 text-sm font-semibold py-2 px-4 rounded-lg gemini-button">＋ Add Failure</button>
                        </div>
                    `;
                case 'reviewAndPlan':
                    return `
                        <div class="space-y-4 p-4 bg-slate-100 rounded-lg">
                            <h5 class="font-semibold">Review Key Tools</h5>
                            <textarea rows="4" class="w-full p-2 border text-sm rounded-md" placeholder="What has changed in your Dashboard? Do your Workview/Lifeview still ring true? What's the first step on your favorite Odyssey Plan? What have you learned from your failures?"></textarea>
                            <h5 class="font-semibold">Next 90 Days Plan</h5>
                            <textarea rows="4" class="w-full p-2 border text-sm rounded-md" placeholder="List 1-3 small, concrete prototypes or actions you will take..."></textarea>
                        </div>
                    `;
                case 'finalReflection':
                     return `
                        <div class="space-y-4 p-4 bg-slate-100 rounded-lg">
                             <textarea rows="3" class="w-full p-2 border text-sm rounded-md" placeholder="What does it mean to you now to live a life of surrender to love?"></textarea>
                             <textarea rows="3" class="w-full p-2 border text-sm rounded-md" placeholder="What does it mean to you now to dare greatly?"></textarea>
                             <textarea rows="3" class="w-full p-2 border text-sm rounded-md" placeholder="What does it mean to you now to live a well-designed life?"></textarea>
                             <textarea rows="5" class="w-full p-2 border text-sm rounded-md" placeholder="Write a letter to your future self..."></textarea>
                        </div>
                     `;
                case 'celebration':
                    return `<textarea rows="3" class="w-full p-2 border text-sm rounded-md" placeholder="How did you celebrate?"></textarea>`;
                default:
                    return `<textarea rows="2" class="mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="Your notes..."></textarea>`;
            }
        }

        function createWeekAccordion(data) {
            const colors = colorMap[data.color];
            let scheduleHtml = Object.keys(data.schedule).map(day => {
                const dayTasks = data.schedule[day];
                return `
                    <div class="py-4 border-b border-slate-200 last:border-b-0">
                        <h4 class="font-bold text-slate-800 capitalize">${day}</h4>
                        ${dayTasks.map(task => `
                            <div class="flex items-start mt-3">
                                <input type="checkbox" class="task-checkbox mt-1 h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                                <div class="ml-3 text-sm flex-1">
                                    <p class="text-slate-600"><span class="font-semibold ${colors.text}">${task.book} ${task.type}:</span> ${task.content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</p>
                                    ${task.reminder ? `<p class="text-xs text-blue-600 italic mt-1">${task.reminder}</p>` : ''}
                                    <div class="mt-2">
                                        ${task.question ? `
                                            <div class="bg-slate-100 p-3 rounded-lg">
                                                <div class="flex justify-between items-center">
                                                    <p class="font-semibold text-sm text-slate-800">${task.question.prompt}:</p>
                                                    <button class="get-unstuck-btn text-xs font-semibold py-1 px-2 rounded-md gemini-button" data-week="${data.week}" data-prompt="${task.question.text}">✨ Get Unstuck</button>
                                                </div>
                                                <p class="text-slate-700 text-sm mt-1">"${task.question.text}"</p>
                                                <textarea rows="3" class="reflection-area mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="Your reflection..."></textarea>
                                                <div class="ai-helper-response text-sm text-slate-600 mt-2"></div>
                                            </div>
                                        ` : ''}
                                        ${task.component ? renderComponent(task) : ''}
                                        ${task.notes ? `<textarea rows="2" class="mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="${task.placeholder || 'Your notes...'}"></textarea>` : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');

            return `
                <div class="mb-4 bg-white rounded-xl shadow-sm overflow-hidden week-container" data-week-id="${data.week}">
                    <div id="week-header-${data.week}" class="accordion-header p-4 md:p-6 cursor-pointer flex justify-between items-center border-l-4 ${colors.border}">
                        <div>
                            <h3 class="text-xl font-bold ${colors.text}">Week ${data.week}: ${data.title}</h3>
                            <p class="text-sm text-slate-500 italic mt-1">"${data.quote}"</p>
                        </div>
                        <svg class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div class="accordion-content">
                        <div class="p-4 md:p-6 border-t border-slate-200">
                            ${scheduleHtml}
                            <div class="mt-6 bg-slate-100 p-3 rounded-lg">
                                <h5 class="font-semibold text-slate-800">Saturday Prototype</h5>
                                <p class="text-sm text-slate-600 mt-1">${data.saturdayPrototype.content}</p>
                                <textarea rows="3" class="prototype-notes-area mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="${data.saturdayPrototype.notes ? 'Notes...' : 'Plan your prototype here...'}"></textarea>
                                ${data.saturdayPrototype.aiPrototype ? `<button class="brainstorm-prototype-btn text-sm font-semibold py-2 px-4 rounded-lg w-full gemini-button mt-2" data-week="${data.week}">✨ Brainstorm Prototypes</button>` : ''}
                            </div>
                             <div class="mt-6 p-4 bg-blue-50 border-l-4 border-blue-400 rounded-r-lg">
                                <h4 class="font-bold text-blue-800">Weekly Integration Notes</h4>
                                <div class="integration-question-area text-sm text-blue-700 mt-1 font-semibold">Complete the week's tasks to generate your personalized integration question.</div>
                                <button class="generate-integration-btn mt-2 text-sm font-semibold py-2 px-4 rounded-lg w-full gemini-button" data-week="${data.week}" disabled>Generate My Integration Question</button>
                                <textarea rows="3" class="integration-notes-area mt-2 w-full p-2 border text-sm border-slate-300 rounded-md" placeholder="Your insights..."></textarea>
                            </div>
                            <div class="mt-6 flex items-center">
                                <input type="checkbox" id="complete-week-${data.week}" data-week="${data.week}" class="h-5 w-5 rounded border-slate-400 text-green-600 focus:ring-green-500">
                                <label for="complete-week-${data.week}" class="ml-2 font-bold text-green-700">Mark Week ${data.week} Complete</label>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function addEventListeners() {
            document.querySelectorAll('.accordion-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('active');
                    header.querySelector('svg').classList.toggle('rotate-180');
                });
            });

            document.querySelectorAll('input[type="checkbox"][data-week]').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const weekNum = e.target.dataset.week;
                    progressState[`week${weekNum}`] = e.target.checked;
                    updateMainTracker();
                });
            });
            
            document.querySelectorAll('.week-container').forEach(container => {
                const checkboxes = container.querySelectorAll('.task-checkbox');
                const genButton = container.querySelector('.generate-integration-btn');
                checkboxes.forEach(cb => {
                    cb.addEventListener('change', () => {
                        const checkedCount = Array.from(checkboxes).filter(c => c.checked).length;
                        if (genButton && (checkedCount / checkboxes.length >= 0.8)) {
                            genButton.disabled = false;
                        } else if (genButton) {
                            genButton.disabled = true;
                        }
                    });
                });
            });

            document.querySelectorAll('.generate-integration-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const weekId = e.target.dataset.week;
                    const weekContainer = e.target.closest('.week-container');
                    const questionArea = weekContainer.querySelector('.integration-question-area');
                    
                    const historicalContext = getHistoricalContext(weekId);
                    let currentWeekContext = `The user's reflections for the current week (Week ${weekId}: ${workbookData[weekId-1].title}) are:\n`;
                    weekContainer.querySelectorAll('textarea').forEach(area => {
                        if(area.value) currentWeekContext += `- ${area.value}\n`;
                    });

                    const fullPrompt = `You are an insightful life design coach. A user is working through a 12-week workbook. 
                    Here is their context from previous weeks:
                    ${historicalContext}

                    Here are their reflections from THIS week:
                    ${currentWeekContext}

                    The core integration theme for this week is: "${workbookData[weekId-1].integration}".

                    Your task is to generate a single, powerful, and personalized integration question for the user to reflect on. This question should synthesize the core theme with their specific reflections from this week and previous weeks. The question should be deep, open-ended, and encourage them to connect the dots in their own life.`;

                    const aiResponse = await callGemini(fullPrompt, e.target);
                    questionArea.innerHTML = aiResponse;
                });
            });

            document.querySelectorAll('.get-unstuck-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const weekId = e.target.dataset.week;
                    const questionPrompt = e.target.dataset.prompt;
                    const reflectionArea = e.target.closest('.bg-slate-100').querySelector('.reflection-area');
                    const userReflection = reflectionArea.value;
                    const responseContainer = e.target.closest('.bg-slate-100').querySelector('.ai-helper-response');
                    
                    const historicalContext = getHistoricalContext(weekId);

                    const fullPrompt = `You are a compassionate and insightful guide. A user is working through a 12-week self-discovery workbook. 
                    Here is the context of their journey so far, based on their previous entries:
                    ${historicalContext}

                    They are currently on Week ${weekId} and are feeling stuck on the following reflection prompt: "${questionPrompt}". 
                    Their current thoughts on this prompt are: "${userReflection}". 
                    
                    Your task is to help them dig deeper without giving them the answer. Provide 2-3 gentle, open-ended questions that connect their current prompt to their previous reflections. Frame your response as helpful suggestions.`;

                    const aiResponse = await callGemini(fullPrompt, e.target);
                    responseContainer.innerHTML = aiResponse.replace(/\n/g, '<br>');
                });
            });

            document.querySelectorAll('.brainstorm-prototype-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const weekId = e.target.dataset.week;
                    const saturdayPrototypeTextarea = e.target.previousElementSibling;
                    
                    const historicalContext = getHistoricalContext(weekId);

                    const fullPrompt = `You are a creative life design coach. A user is looking for prototype ideas for their weekend based on their reflections in a 12-week workbook.
                    Here is the context of their journey so far, based on their previous entries:
                    ${historicalContext}
                    
                    They are currently at the end of Week ${weekId} (focused on: "${workbookData[weekId-1].title}"). Their task is to: "${workbookData[weekId-1].saturdayPrototype.content}".
                    
                    Your task is to suggest 3 concrete, small, low-cost "prototype" ideas (a mix of conversation, experience, and research prototypes) that are actionable this weekend. The ideas should be highly personalized based on their previous reflections. Format the response as a numbered list with brief explanations.`;
                    
                    const aiResponse = await callGemini(fullPrompt, e.target);
                    saturdayPrototypeTextarea.value = aiResponse;
                });
            });
            
            document.body.addEventListener('input', e => {
                if (e.target.matches('input[type="range"]')) {
                    const label = document.getElementById(e.target.dataset.labelId);
                    if (label) {
                        label.textContent = `${e.target.value}%`;
                    }
                }
            });

            document.getElementById('fab-add-journal').addEventListener('click', () => {
                editingJournalIndex = null;
                document.getElementById('journal-modal-title').textContent = 'Add Good Time Journal Entry';
                document.getElementById('journal-activity-input').value = '';
                document.getElementById('journal-engagement-input').value = '';
                document.getElementById('journal-energy-input').value = '';
                document.getElementById('journal-modal').classList.remove('hidden');
                document.getElementById('journal-modal').classList.add('flex');
            });
            
            document.getElementById('fab-view-journal').addEventListener('click', () => {
                renderJournalEntries(); // Ensure the view is up to date
                document.getElementById('journal-view-modal').classList.remove('hidden');
                document.getElementById('journal-view-modal').classList.add('flex');
            });

            document.getElementById('cancel-journal-entry').addEventListener('click', () => {
                document.getElementById('journal-modal').classList.add('hidden');
                document.getElementById('journal-modal').classList.remove('flex');
            });
            
            document.getElementById('close-journal-view').addEventListener('click', () => {
                document.getElementById('journal-view-modal').classList.add('hidden');
                document.getElementById('journal-view-modal').classList.remove('flex');
            });

            document.getElementById('save-journal-entry').addEventListener('click', () => {
                const activity = document.getElementById('journal-activity-input').value;
                const engagement = parseInt(document.getElementById('journal-engagement-input').value, 10) || 0;
                const energy = parseInt(document.getElementById('journal-energy-input').value, 10) || 0;

                if(activity) {
                    const newEntry = { activity, engagement, energy, date: new Date().toLocaleDateString() };
                    if (editingJournalIndex !== null) {
                        goodTimeJournal[editingJournalIndex] = newEntry;
                    } else {
                        goodTimeJournal.push(newEntry);
                    }
                    renderJournalEntries();
                    document.getElementById('journal-modal').classList.add('hidden');
                    document.getElementById('journal-modal').classList.remove('flex');
                }
            });

            document.body.addEventListener('click', e => {
                if (e.target.matches('#add-failure-btn')) {
                    const tableBody = document.getElementById('failure-table-body');
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td class="p-1"><input type="text" class="w-full p-1 border rounded-md"></td>
                        <td class="p-1">
                            <select class="w-full p-1 border rounded-md">
                                <option>Screwup</option>
                                <option>Weakness</option>
                                <option>Growth Opportunity</option>
                            </select>
                        </td>
                        <td class="p-1"><input type="text" class="w-full p-1 border rounded-md"></td>
                        <td class="p-1 text-center"><button class="text-red-500 font-bold">X</button></td>
                    `;
                    row.querySelector('button').onclick = () => row.remove();
                }
                if (e.target.matches('.populate-mind-map-btn')) {
                    populateMindMapDropdowns(e.target);
                }
                if (e.target.closest('.edit-journal-btn')) {
                    const button = e.target.closest('.edit-journal-btn');
                    const index = parseInt(button.dataset.index, 10);
                    editingJournalIndex = index;
                    const entry = goodTimeJournal[index];
                    
                    document.getElementById('journal-modal-title').textContent = 'Edit Good Time Journal Entry';
                    document.getElementById('journal-activity-input').value = entry.activity;
                    document.getElementById('journal-engagement-input').value = entry.engagement;
                    document.getElementById('journal-energy-input').value = entry.energy;
                    
                    document.getElementById('journal-modal').classList.remove('hidden');
                    document.getElementById('journal-modal').classList.add('flex');
                }
            });
        }

        function renderJournalEntries() {
            const viewContent = document.getElementById('journal-view-content');
            const containers = document.querySelectorAll('.journal-entries-container');
            
            const renderList = (container) => {
                const placeholder = container.querySelector('p');
                container.innerHTML = '';
                if (placeholder) container.appendChild(placeholder);
                
                if (goodTimeJournal.length > 0) {
                    if(placeholder) placeholder.classList.add('hidden');
                    goodTimeJournal.forEach((entry, index) => {
                        const entryEl = document.createElement('div');
                        entryEl.className = 'p-2 border border-slate-200 rounded-lg bg-white text-sm flex justify-between items-center';
                        entryEl.innerHTML = `
                            <div>
                                <p class="font-semibold">${entry.activity} <span class="text-xs font-normal text-slate-400 ml-2">${entry.date}</span></p>
                                <p class="text-xs text-slate-500">Engagement: ${entry.engagement}/10 | Energy: ${entry.energy}/10</p>
                            </div>
                            <button class="edit-journal-btn p-1 text-slate-400 hover:text-blue-600" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" />
                                </svg>
                            </button>
                        `;
                        container.appendChild(entryEl);
                    });
                } else {
                    if(placeholder) placeholder.classList.remove('hidden');
                }
            }

            containers.forEach(renderList);
            renderList(viewContent);
        }

        function populateMindMapDropdowns(button) {
            const mindMapContainer = button.closest('.p-4');
            const selects = mindMapContainer.querySelectorAll('.mind-map-select');

            selects.forEach(select => {
                const sortKey = select.dataset.sortKey;
                let sortedEntries = [...goodTimeJournal];

                if (sortKey === 'engagement') {
                    sortedEntries.sort((a, b) => b.engagement - a.engagement);
                } else if (sortKey === 'energy') {
                    sortedEntries.sort((a, b) => b.energy - a.energy);
                } else if (sortKey === 'flow') {
                    sortedEntries.sort((a, b) => (b.engagement + b.energy) - (a.engagement + a.energy));
                }
                
                select.innerHTML = '<option>Select a Central Topic</option>';
                sortedEntries.forEach(entry => {
                    const option = document.createElement('option');
                    option.value = entry.activity;
                    option.textContent = `${entry.activity} (E:${entry.engagement}, N:${entry.energy})`;
                    select.appendChild(option);
                });
            });
             button.textContent = "Topics Loaded!";
             setTimeout(() => { button.textContent = "Reload Topics from Journal"; }, 2000);
        }

        function updateMainTracker() {
            for (let i = 1; i <= 12; i++) {
                const item = document.getElementById(`progress-item-${i}`);
                if (progressState[`week${i}`]) {
                    item.classList.add('completed');
                    item.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mx-auto" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                    `;
                } else {
                    item.classList.remove('completed');
                    item.textContent = i;
                }
            }
        }
        
        document.addEventListener('DOMContentLoaded', initializeApp);

    </script>
</body>
</html>
